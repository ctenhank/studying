# System Monitoring

## **시스템 모니터링이란?**

- 시스템의 동작 여부 파악과 시스템의 성능을 이해

  > **성능(Performance)**
  >
  > 각 요청의 응답시간과 이에 사용된 CPU 사용량뿐만 아니라 더 넓은 의미
  >
  > - 고객의 주문을 처리하기 위해 얼마나 많은 데이터베이스 요청이 필요한가?
  > - 처리량이 더 큰 네트워크 장비를 구매해야 할 시점일까?
  > - 캐시 미스를 처리하기 위해 얼마나 많은 머신이 필요한가?
  > - 복잡한 기능을 유지하는 것이 당연할 만큼 사용자가 해당 기능을 충분하게 사용하고 있는가?

- 메트릭 기반 모니터링 시스템은 이런 종류의 질문에 답과 그 이유를 구할 때 도움

- 고수준의 개요부터 디버깅에 유용한 핵심 세부사항에 이르기까지, 시스템 전반에 걸쳐 통찰을 얻는 것

- 디버깅과 분석을 위한 전체 모니터링 도구에는 메트릭^1^뿐 아니라 로그, 트레이싱, 프로파일링도 포함
  *^1^ 시스템 수준의 질문에 대한 답을 구하려는 경우에는 메트릭이 첫 번째 항목이 되야 함*

- 프로메테우스를 활용하면 어플리케이션에서 베어메탈까지 시스템 전반에 걸쳐 자유롭게 계측(instrumentation) 수행 가능



## 모니터링 유형

컴퓨터 시스템에 대한 운영 모니터링의 종류는 다음 4가지로 좁힐 수 있음

-  **알림(alert)**
  문제가 발생한 시기나 시점을 파악하고 책임 운영자를 호출하는 것

-  **디버깅(debugging)**

  문제의 근본 원인을 규명하고, 문제가 무엇이든 해결하하는 것

-  **추세 파악(trending)**
  알림과 디버깅은 보통 몇 분부터 몇 시간까지 시간 단위로 발생
  긴급하지 않은 문제인 경우에는 시스템이 어떻게 사용되고 시간에 따라 변화하는지를 확인할 수 있는 기능도 유용
  용량 계획(Capacity planning) 같은 설계 결정과 프로세스에 영향을 미칠 수 있음

-  **플러밍(plumbing)**
  모든 모니터링 시스템은 데이터 처리 파이프라인
  때로는 맞춤형 솔루션을 만들기보단 모니터링 시스템의 일부를 다른 목적으로 적절하게 사용하는 편이 좋음



## 모니터링 범주

대부분의 모니터링은 이벤트에 대한 것이고, 다음과 같은 사항을 비롯해 거의 모든 것이 포함

> HTTP 요청 수신, HTTP 400 응답 송신, 함수 시작
>
> if문의 else 도달, 함수 종료, 사용자 로그인, 디스크에 데이터 쓰기

- 모든 이벤트에는 ***컨텍스트(Context)***가 존재

  > **Context**
  >
  > 어떤 이벤트가 발생하면, 그 이벤트 전후로의 모든 활동 및 데이터
  >
  > 예를 들어, HTTP 요청에는 들어오고 나가는 IP 주소, 요청 URL, 설정된 쿠키, 요청한 사용자 정보 등

- 컨텍스트를 파악하면 디버깅에 큰 도움이 되고 시스템 수행 방법을 이해할 수 있지만, 처리 및 저장해야 하는 데이터 양이 증가
- 데이터 양을 감소시킬 수 있는 네 가지 방법
  - **프로파일링(Profiling)**
  - **트레이싱(Tracing)**
  - **로깅(Logging)**
  - **메트릭(Metric)**



## 데이터 양 감소시키는 방법

### 프로파일링(Profiling)

모든 시간에 대해 모든 이벤트의 컨텍스트를 가질 수 없지만, 제한된 기간의 일부 컨텍스트를 가질 수 있다는 방식으로 접근

> Tcpdump, debug builds, eBPF



### 트레이싱(Tracing)

모든 이벤트를 살펴보는 것이 아니라, 특정 이벤트에만 집중

- stack trace에서 관심 있는 부분의 함수들을 기록하고, 때때로 이러한 함수들이 얼마나 오랫동안 수행됐는지 기록

- 일부는 관심 지점에서 stack trace에 스냅샷을 수집하는 대신, 관심있는 함수 하위의 모든 함수 호출을 추적하고 타이밍(시간)을 기록

-  분산 트레이싱(distributed tracing)은 RPC에서 다른 프로세스로 전달되는 요청에 고유한 ID를 추가해, 
  해당 요청이 추적되어야 하는지 여부 등 프로세스 전반에 걸친 작업을 추적

  > 이러한 분산 트레이싱은 분산 마이크로서비스 아키텍처의 디버깅에 필수적인 도구
  >
  > OpenZipkin, Jaeger 등이 있음

- 트레이싱에서 데이터 볼륨 유지 및 계측 성능에 영향을 미치는 것은 샘플링(Sampling)



### 로깅(Logging)

제한된 이벤트 집합을 살펴보고 각 이벤트에 대한 컨텍스트 일부를 기록

> 예를 들어,
>
> 로깅은 수신되는 모든 HTTP 요청이나 발신되는 모든 데이터베이스 호출같은 이벤트를 살펴보고 기록
> 자원의 낭비를 방지하려면 로그 항목별로 수백 개 정도의 필드 개수를 제한
> 이 외에도 대역폭과 저장 장치가 문제가 되기도 함

- 로깅의 가장 큰 장점은 이벤트에 대한 샘플링이 없다는 점

- 필드 개수를 제한하더라도, 시간이 오래 걸리는 요청이 특정 API 엔드포인트와 통신하는 특정 유저에게 얼마나 영향을 미치는지 판단해야 함

- 로깅 유형:

  #####  트랜잭션 로그(Transaction Log):

  - 어떠한 대가를 치르더라도 영원히 안전하게 보관해야 하는 중요한 비즈니스 기록

  #####  요청 로그(Request Log):

  - 모든 HTTP request, 데이터베이스 호출을 추적하는 경우의 로그
  - 요청 로그는 사용자 직접 사용하는 기능이나 내부 최적화의 구현에 쓰일 수 있음
  - 삭제되더라도 큰 문제가 되지는 않음

  #####  어플리케이션 로그(Application Log):

  - 모든 로그가 request 로그인 것은 아니며, 프로세스 그 자체에 관한 로그

    > 시작 메시지, 백그라운드 유지보수 작업, 그 밖에 프로세스 수준의 로그들 

  #####  디버그 로그(Debug Log):

  - 디버그 로그는 굉장히 상세해서 생성과 저장에 많은 비용이 듬
  - 주로 매우 협소한 디버깅 상황에만 사용되며, 데이터 양 때문에 프로파일링 특성을 띔
  - 신뢰성과 보유 요구사항이 낮은 편이며, 거의 디버그 로그가 생성된 머신에서만 유용



### 메트릭(Metric)

컨텍스트를 대부분 무시하고 다양한 유형의 이벤트에 대해 시간에 따른 집계(aggregation)를 추적

> 예를 들어, 수신된 HTTP 요청 횟수, 요청을 처리하는 데 걸린 시간, 현재 진행중인 요청 수 등

- 자원 사용을 정상적으로 유지하려면, 추적하는 메트릭의 개수를 제한

  > 프로세스당 1만 개의 메트릭 처리 정도가 합리적인 상한선 

- 컨텍스트 정보를 제외하면 필요한 데이터 양과 처리는 합리적인 수준으로 유지

- 메트릭을 이용하면 어플리케이션의 각 서브시스템에서의 대기 시간과 처리하는 데이터 양을 추적해 성능 저하의 원인이 무엇인지 손쉽게 알 수 있음

